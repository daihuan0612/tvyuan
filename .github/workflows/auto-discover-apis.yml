name: Auto Discover and Add APIs

on:
  schedule:
    - cron: "0 16 * * 0"  # æ¯å‘¨åŒ—äº¬æ—¶é—´å‘¨æ—¥å‡Œæ™¨0ç‚¹è¿è¡Œ (UTC 16ç‚¹å‘¨æ—¥)
  workflow_dispatch:

jobs:
  auto-discover-apis:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # å…è®¸æ¨é€

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - uses: actions/checkout@v4

      # 2ï¸âƒ£ å®‰è£…ç³»ç»Ÿä¾èµ– & Node.js
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install bs58 axios

      # 3ï¸âƒ£ è¿è¡Œè‡ªåŠ¨å‘ç°å¹¶æ·»åŠ APIå·¥ä½œæµ
      - name: Run auto discover and add APIs workflow
        run: |
          echo "ğŸš€ å¼€å§‹è‡ªåŠ¨å‘ç°å¹¶æ·»åŠ APIå·¥ä½œæµ..."
          node auto_discover_and_add.js

      # 4ï¸âƒ£ æäº¤å¹¶æ¨é€æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶
      - name: Commit and push all generated files
        run: |
          # é…ç½® Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œæ— éœ€æäº¤"
            exit 0
          fi
          
          # æ‹‰å–è¿œç¨‹ main åˆ†æ”¯ï¼Œé¿å…å†²çª
          git fetch origin main
          git reset --soft origin/main

          # æ·»åŠ æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶
          git add LunaTV-config.json jingjian.json jin18.json LunaTV-config.txt jingjian.txt jin18.txt report.md README.md discovered_apis.json

          # æäº¤æ›´æ–°
          git commit -m "è‡ªåŠ¨å‘ç°å¹¶æ·»åŠ æ–°API ($(date -d '+8 hour' +'%Y-%m-%d %H:%M:%S CST'))"

          # æ¨é€åˆ°è¿œç¨‹ main
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main